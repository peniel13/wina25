{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}
<section class="pt-8 bg-white">

  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Messages -->
    <div class="mt-4">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} p-4 rounded-md mb-4">
          <p class="text-center text-sm">{{ message }}</p>
        </div>
      {% endfor %}
    </div>

    <!-- Banni√®re -->
    <!-- Banni√®re -->
<div class="relative w-full h-64 sm:h-80 md:h-96 mt-8 rounded-lg overflow-hidden">
    <img src="{% if immobusiness.image_principale %}{{ immobusiness.image_principale.url }}{% else %}{% static 'img/lushipalais.jpg' %}{% endif %}"
         alt="{{ immobusiness.nom }}"
         class="absolute inset-0 w-full h-full object-cover">
  
    <div class="absolute inset-0 bg-black bg-opacity-60 flex flex-col justify-center items-center text-center px-4 sm:px-6 md:px-8 py-6">
      <h2 class="text-2xl sm:text-3xl font-semibold text-white mb-4">{{ immobusiness.nom }}</h2>
      <h3 class="text-lg sm:text-xl md:text-2xl font-semibold text-white mb-6">{{ immobusiness.type_bien }} √† {{ immobusiness.commune }}</h3>
       
      <!-- Contenu principal -->
      <div class="bg-green-100 bg-opacity-80 p-4 sm:p-6 rounded-lg shadow-md max-w-full sm:max-w-3xl">
  
        <!-- Version desktop (affiche toute la description) -->
        <div class="hidden sm:block">
          <h4 class="text-base sm:text-lg md:text-xl font-semibold text-green-800 mb-2">
            Opportunit√© : {{ immobusiness.objectif|capfirst }}
          </h4>
          <p class="text-sm sm:text-base text-gray-600">{{ immobusiness.description }}</p>
        </div>
  
        <!-- Version mobile (affiche partiellement + bouton Lire plus) -->
        <div class="block sm:hidden">
          <h4 class="text-base font-semibold text-green-800 mb-2">
            Opportunit√© : {{ immobusiness.objectif|capfirst }}
          </h4>
  
          {% if immobusiness.description|length > 150 %}
            <p class="text-sm text-gray-600">
              {{ immobusiness.description|slice:":150" }}...
            </p>
            <button id="showDescriptionBtn"
                    class="mt-3 text-blue-700 underline text-sm font-semibold">
              Lire plus
            </button>
          {% else %}
            <p class="text-sm text-gray-600">{{ immobusiness.description }}</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  <!-- Pop-up (modal) pour description compl√®te sur mobile) -->
  <div id="descriptionModal"
       class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-lg p-6 w-11/12 max-w-md">
      <h3 class="text-lg font-semibold text-green-800 mb-3">Description compl√®te</h3>
      <p class="text-gray-700 text-sm mb-4">{{ immobusiness.description }}</p>
      <button id="closeDescriptionBtn"
              class="mt-2 w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition">
        Fermer
      </button>
    </div>
  </div>
  
  <!-- Script -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const showBtn = document.getElementById('showDescriptionBtn');
      const modal = document.getElementById('descriptionModal');
      const closeBtn = document.getElementById('closeDescriptionBtn');
  
      if (showBtn && modal && closeBtn) {
        showBtn.addEventListener('click', () => {
          modal.classList.remove('hidden');
        });
  
        closeBtn.addEventListener('click', () => {
          modal.classList.add('hidden');
        });
  
        // Fermer en cliquant √† l'ext√©rieur
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.add('hidden');
          }
        });
      }
    });
  </script>
  

    <!-- Galerie -->
    {% if immobusiness.gallery.all %}
    <div class="mt-8 max-w-4xl mx-auto">
      <h4 class="text-xl font-semibold mb-4">Galerie du bien</h4>
      <div class="relative">
        <img id="gallery-image" src="{{ immobusiness.gallery.all.0.image.url }}"
             class="w-full h-96 object-cover rounded-lg shadow-md transition-transform duration-300 hover:scale-105"
             alt="Image galerie">
        <button id="prev-btn"
                class="absolute left-2 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-70 text-gray-800 px-3 py-2 rounded-full hover:bg-opacity-100">&lt;</button>
        <button id="next-btn"
                class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-white bg-opacity-70 text-gray-800 px-3 py-2 rounded-full hover:bg-opacity-100">&gt;</button>
      </div>
    </div>
    {% endif %}

    <!-- Informations -->
    <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-md mt-8">
      <p class="text-sm text-gray-500 mb-2">Publi√© {{ immobusiness.created_at|naturaltime }}</p>
      <p class="text-sm text-gray-600 mb-1">Type : {{ immobusiness.type_bien }} | Objectif : {{ immobusiness.objectif|capfirst }}</p>
      <p class="text-sm text-gray-600">
        Commune : {{ immobusiness.commune }} - Ville :
        {% if immobusiness.city %}{{ immobusiness.city.name }}{% endif %},
        Pays :
        {% if immobusiness.country %}{{ immobusiness.country.name }}{% endif %}
      </p>
      {% if immobusiness.prix %}
      <p class="text-lg font-semibold text-green-700 mb-2">
        Prix : {{ immobusiness.prix|floatformat:0 }} {% if immobusiness.devise %}{{ immobusiness.devise }}{% endif %}
      </p>
    {% endif %}
    
      {% if immobusiness.audio %}
      <div class="mt-4">
        <p class="text-sm text-gray-600">√âcoutez la description audio :</p>
        <audio controls class="w-full mt-2">
          <source src="{{ immobusiness.audio.url }}" type="audio/mpeg">
          Votre navigateur ne supporte pas l‚Äô√©l√©ment audio.
        </audio>
      </div>
      {% endif %}
    </div>

    <!-- Formulaire de r√©ponse -->
    <div class="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto mt-8">
      <h4 class="text-2xl font-semibold mb-6 text-center">
        R√©pondre √† ce bien immobilier
      </h4>

      <form method="POST" enctype="multipart/form-data" class="space-y-4">
        {% csrf_token %}
        {{ form.as_p }}

        <!-- Zone d‚Äôenregistrement vocal -->
        <div class="mt-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Enregistrement vocal (optionnel)</label>
          <div class="flex flex-col items-center space-y-3">
            <button type="button" id="start-record" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">üéôÔ∏è Commencer l‚Äôenregistrement</button>
            <button type="button" id="stop-record" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600" disabled>‚èπÔ∏è Arr√™ter</button>
            <audio id="audio-preview" controls class="hidden w-full mt-4"></audio>
            <input type="hidden" name="audio_data" id="audio-data">
          </div>
        </div>

        <div class="flex justify-center items-center mt-6">
          <button type="submit"
                  class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            Soumettre ma r√©ponse
          </button>
        </div>
      </form>
    </div>

    <!-- R√©ponses admin -->
    {% if user.is_staff %}
    <div class="mt-8 max-w-4xl mx-auto space-y-6 mb-16">
      <h3 class="text-xl font-semibold text-gray-800">R√©ponses re√ßues ({{ responses_count }})</h3>
      {% if responses %}
        {% for resp in responses %}
          <div class="bg-gray-100 p-4 rounded-lg shadow-md">
            <p><strong>Nom :</strong> {{ resp.nom }} {{ resp.post_nom }}</p>
            <p><strong>Email :</strong> {{ resp.email }}</p>
            <p><strong>T√©l√©phone :</strong> {{ resp.telephone }}</p>
            <p><strong>Message :</strong> {{ resp.message|linebreaksbr }}</p>
            {% if resp.audio %}
              <div class="mt-2">
                <p><strong>Audio :</strong></p>
                <audio controls class="w-full mt-1">
                  <source src="{{ resp.audio.url }}" type="audio/mpeg">
                  Votre navigateur ne supporte pas l‚Äô√©l√©ment audio.
                </audio>
              </div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <p class="text-gray-600">Aucune r√©ponse n‚Äôa encore √©t√© soumise.</p>
      {% endif %}
    </div>
    {% endif %}
  </div>

</section>

<!-- JS Galerie -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  {% if immobusiness.gallery.all %}
  const images = [
    {% for img in immobusiness.gallery.all %}
      "{{ img.image.url }}"{% if not forloop.last %},{% endif %}
    {% endfor %}
  ];
  let currentIndex = 0;
  const galleryImg = document.getElementById('gallery-image');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');

  prevBtn.addEventListener('click', () => {
    currentIndex = (currentIndex - 1 + images.length) % images.length;
    galleryImg.src = images[currentIndex];
  });

  nextBtn.addEventListener('click', () => {
    currentIndex = (currentIndex + 1) % images.length;
    galleryImg.src = images[currentIndex];
  });
  {% endif %}
});
</script>

<!-- JS Enregistrement vocal -->
<script>
let mediaRecorder;
let audioChunks = [];

document.getElementById("start-record").addEventListener("click", async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.start();
  audioChunks = [];

  document.getElementById("start-record").disabled = true;
  document.getElementById("stop-record").disabled = false;

  mediaRecorder.addEventListener("dataavailable", event => {
    audioChunks.push(event.data);
  });
});

document.getElementById("stop-record").addEventListener("click", () => {
  mediaRecorder.stop();
  document.getElementById("stop-record").disabled = true;
  document.getElementById("start-record").disabled = false;

  mediaRecorder.addEventListener("stop", () => {
    const audioBlob = new Blob(audioChunks, { type: "audio/mpeg" });
    const audioUrl = URL.createObjectURL(audioBlob);
    const audioPreview = document.getElementById("audio-preview");
    audioPreview.src = audioUrl;
    audioPreview.classList.remove("hidden");

    const reader = new FileReader();
    reader.readAsDataURL(audioBlob);
    reader.onloadend = function() {
      document.getElementById("audio-data").value = reader.result;
    };
  });
});
</script>

{% endblock %}
