{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">

  <h2 class="text-2xl font-bold mb-6">Visite + et gagne +üíµ</h2>

  <div id="invites" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mt-6 mb-4">
    {% for invite in invites %}
      {% if invite.type_invite == 'store' and invite.store %}
      <a href="{% url 'store_detail' slug=invite.store.slug %}?invite_id={{ invite.id }}" target="_blank" class="flex-shrink-0 relative border rounded-lg shadow hover:shadow-lg overflow-hidden bg-white">
        <div class="h-40 bg-cover bg-center" style="background-image: url('{% if invite.store.thumbnail %}{{ invite.store.thumbnail.url }}{% else %}{% static 'img/default-thumbnail.jpg' %}{% endif %}')">
          {% if invite.store.country.flag %}
            <div class="absolute top-2 right-2">
              <img src="{{ invite.store.country.flag.url }}" class="w-5 h-5 rounded-full border border-white shadow" alt="{{ invite.store.country.name }}">
            </div>
          {% endif %}
        </div>
        <div class="bg-black bg-opacity-60 text-white p-3 text-sm">
          <h3 class="font-semibold truncate">{{ invite.store.name }}</h3>
          <p class="text-xs text-blue-200 italic">{{ invite.store.typestore.nom }}</p>
          <p class="truncate mt-1">{{ invite.store.adresse }}</p>
          <p class="text-xs">{{ invite.store.city.name }}, {{ invite.store.country.name }}</p>
          <p class="mt-1 text-xs">Visites restantes : {{ invite.visites_restantes }}</p>
        </div>
      </a>
      
      {% elif invite.type_invite == 'lien' %}
        <a href="{% url 'invite_redirect' invite.id %}" target="_blank" class="flex-shrink-0 relative border rounded-lg shadow hover:shadow-lg overflow-hidden bg-white">
          <div class="h-40 bg-cover bg-center" style="background-image: url('{% if invite.image %}{{ invite.image.url }}{% else %}{% static 'img/default-thumbnail.jpg' %}{% endif %}')"></div>
          <div class="bg-black bg-opacity-60 text-white p-3 text-sm">
            <h3 class="font-semibold truncate">Lien externe</h3>
            <p class="truncate mt-1 text-blue-200 underline">{{ invite.url_redirection }}</p>
            <p class="mt-1 text-xs">Visites restantes : {{ invite.visites_restantes }}</p>
          </div>
        </a>
      {% endif %}
    {% empty %}
      <p class="text-gray-500">Aucune invitation de visibilit√© active trouv√©e.</p>
    {% endfor %}
  </div>

</div>
{% if ad_popup and ad_popup.is_active %}
<div id="popupAd" class="modal show d-block" tabindex="-1"
     style="background: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; display: flex; justify-content: center;
            align-items: center; z-index: 9999;">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 90%; width: auto;">
        <div class="modal-content position-relative">
            <button type="button" class="btn-close" onclick="closePopup()"
                    style="border: none; background: none; font-size: 30px;
                           color: #fff; position: absolute; top: 20px; right: 20px;">&times;
            </button>
            <div class="modal-body text-center" style="display: flex; flex-direction: column;
                                                        justify-content: space-between; max-height: 80vh;">

                {% if ad_popup.media_type == "image" %}
                    <img src="{{ ad_popup.file.url }}" class="img-fluid"
                         style="max-height: 70vh; width: auto; margin-bottom: 20px;" alt="Publicit√©">
                {% else %}
                    <video autoplay controls class="img-fluid"
                           style="max-height: 70vh; width: auto; margin-bottom: 20px;">
                        <source src="{{ ad_popup.file.url }}" type="video/mp4">
                    </video>
                {% endif %}

                <div class="mt-4 d-flex flex-wrap justify-content-center gap-3">

                    {% if ad_popup.url %}
                        <a href="{{ ad_popup.url }}" target="_blank"
                           class="btn btn-danger"
                           style="font-size: 18px; padding: 10px 20px; background-color: #ff5733;
                                  border: none; color: white; border-radius: 5px;
                                  transition: background-color 0.3s ease;">
                            üîó Voir l'annonce
                        </a>
                    {% endif %}

                    {% if ad_popup.store %}
                        <a href="{% url 'store_detail' ad_popup.store.slug %}"
                           class="btn btn-primary"
                           style="font-size: 18px; padding: 10px 20px; background-color: #007bff;
                                  border: none; color: white; border-radius: 5px;
                                  transition: background-color 0.3s ease;">
                            üè¨ Visiter le store
                        </a>
                    {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
<script>
    function closePopup() {
        const popup = document.getElementById("popupAd");
    
        // Stopper la vid√©o s'il y en a une
        const video = popup.querySelector("video");
        if (video) {
            video.pause();
            video.currentTime = 0; // optionnel : remet la vid√©o au d√©but
        }
    
        // Cacher le popup
        popup.style.display = "none";
    }
</script>
{% endblock %}
