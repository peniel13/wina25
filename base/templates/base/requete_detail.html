{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="pt-8 bg-white">

  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Messages -->
    <div class="mt-4">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} p-4 rounded-md mb-4">
          <p class="text-center text-sm">{{ message }}</p>
        </div>
      {% endfor %}
    </div>

    <!-- Banni√®re -->
   <!-- Banni√®re responsive avec padding s√©curis√© -->
<div class="relative w-full h-64 sm:h-80 md:h-96 mt-8 rounded-lg overflow-hidden">
    <!-- Image de fond -->
    <img src="{% static 'img/lushipalais.jpg' %}" alt="Image de fond"
         class="absolute inset-0 w-full h-full object-cover">
  
    <!-- Overlay sombre -->
    <div class="absolute inset-0 bg-black bg-opacity-60 flex flex-col justify-center items-center text-center px-4 sm:px-6 md:px-8 py-6">
      
      <!-- Titre principal (vide pour l'instant) -->
      <h2 class="text-2xl sm:text-3xl font-semibold text-white mb-4 break-words max-w-full sm:max-w-2xl">
        <!-- Titre si besoin -->
      </h2>
  
      <!-- Sous-titre -->
      <h3 class="text-lg sm:text-xl md:text-2xl font-semibold text-white mb-6 break-words max-w-full sm:max-w-2xl">
        Client recherche {{ requete.type_bien }} √† {{ requete.commune }}
      </h3>
  
      <!-- Bloc d'information -->
      <div class="bg-green-100 bg-opacity-80 p-4 sm:p-6 rounded-lg shadow-md max-w-full sm:max-w-3xl break-words">
        <h4 class="text-base sm:text-lg md:text-xl font-semibold text-green-800 mb-2 break-words">
          Un client recherche un(e) {{ requete.type_bien }} √† {{ requete.commune }}
        </h4>
        <p class="text-sm sm:text-base text-gray-600 break-words">
          Aidez-le √† trouver le bien parfait ! Si votre description correspond, nous vous mettrons en contact.
          <strong>Gagnez vos commissions</strong> en offrant des biens adapt√©s !
        </p>
      </div>
  
    </div>
  </div>
  

    <!-- D√©tails de la requ√™te -->
    <div class="bg-gray-50 p-4 sm:p-6 rounded-lg shadow-md mt-8">
      <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-2">
        Recherche {{ requete.type_bien }} √† {{ requete.commune }}
      </h3>
      <p class="text-sm sm:text-base text-gray-600 mb-4">{{ requete.description }}</p>

      {% if requete.audio %}
      <div class="mt-4">
        <p class="text-sm text-gray-600">√âcoutez la description audio :</p>
        <audio controls class="w-full mt-2">
          <source src="{{ requete.audio.url }}" type="audio/mpeg">
          Votre navigateur ne supporte pas l‚Äô√©l√©ment audio.
        </audio>
      </div>
      {% endif %}

      <p class="text-sm text-gray-500 mt-4">Nombre de r√©ponses : <strong>{{ responses_count }}</strong></p>
    </div>

    <!-- Formulaire de r√©ponse -->
    <div class="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto">
        <h4 class="text-2xl font-semibold mb-6 text-center">R√©pondre √† cette requ√™te si Vous avez un bien immobilier tel que d√©crit par le client. </h4>

        <form method="POST" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}

            <!-- Champ Nom -->
            <div>
                <label for="nom" class="block text-sm font-medium text-gray-700">Nom</label>
                <input type="text" id="nom" name="nom" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Entrez votre nom" required>
            </div>

            <!-- Champ Post-nom -->
            <div>
                <label for="post_nom" class="block text-sm font-medium text-gray-700">Post-nom</label>
                <input type="text" id="post_nom" name="post_nom" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Entrez votre post-nom" required>
            </div>

            <!-- Champ Email -->
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Entrez votre email" required>
            </div>

            <!-- Champ T√©l√©phone -->
            <div>
                <label for="telephone" class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
                <input type="text" id="telephone" name="telephone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Entrez votre num√©ro de t√©l√©phone" required>
            </div>

            <!-- Champ Message (Description de la r√©ponse) -->
            <div>
                <label for="message" class="block text-sm font-medium text-gray-700">Votre message</label>
                <textarea id="message" name="message" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="D√©crivez votre r√©ponse" rows="4" required></textarea>
            </div>

            <!-- Champ Audio (facultatif) -->
            <!-- Boutons pour l‚Äôaudio -->
<div class="mt-4 space-y-2">
    <label class="block text-sm font-medium text-gray-700">R√©ponse audio (facultative)</label>
    <div class="flex space-x-2 items-center">
      <button type="button" id="record-btn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600">üé§ Enregistrer</button>
      <button type="button" id="stop-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600" disabled>‚èπ Arr√™ter</button>
      <button type="button" id="play-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600" disabled>‚ñ∂ R√©√©couter</button>
      <button type="button" id="delete-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600" disabled>üóë Supprimer</button>
    </div>
    <audio id="audio-preview" controls style="display: none; width: 100%; margin-top: 8px;"></audio>
    <!-- Champ cach√© pour stocker l‚Äôaudio encod√© (base64) -->
    <input type="hidden" name="audio_blob" id="audio-blob-input">
  </div>
  

            <!-- Bouton Soumettre -->
            <div class="flex justify-center items-center mt-6">
                <button type="submit" class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Soumettre ma r√©ponse
                </button>
            </div>
        </form>
    </div>
    
  </div>
  {% if user.is_staff %}
  <!-- Section : r√©ponses existantes -->
  <div class="mt-8 max-w-4xl mx-auto space-y-6 mb-16">
    <h3 class="text-xl font-semibold text-gray-800">R√©ponses re√ßues ({{ responses_count }})</h3>
    {% if responses %}
      {% for resp in responses %}
        <div class="bg-gray-100 p-4 rounded-lg shadow-md">
          <p><strong>Nom :</strong> {{ resp.nom }} {{ resp.post_nom }}</p>
          <p><strong>Email :</strong> {{ resp.email }}</p>
          <p><strong>T√©l√©phone :</strong> {{ resp.telephone }}</p>
          <p><strong>Message :</strong> {{ resp.message|linebreaksbr }}</p>
          {% if resp.audio %}
            <div class="mt-2">
              <p><strong>Audio :</strong></p>
              <audio controls class="w-full mt-1">
                <source src="{{ resp.audio.url }}" type="audio/mpeg">
                Votre navigateur ne supporte pas l‚Äô√©l√©ment audio.
              </audio>
            </div>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p class="text-gray-600">Aucune r√©ponse n‚Äôa encore √©t√© soumise.</p>
    {% endif %}
  </div>
{% endif %}

  
</section>
<script>
    document.addEventListener('DOMContentLoaded', function () {
      let mediaRecorder;
      let audioChunks = [];
    
      const recordBtn = document.getElementById('record-btn');
      const stopBtn = document.getElementById('stop-btn');
      const playBtn = document.getElementById('play-btn');
      const deleteBtn = document.getElementById('delete-btn');
      const audioPreview = document.getElementById('audio-preview');
      const audioBlobInput = document.getElementById('audio-blob-input');
    
      recordBtn.addEventListener('click', async () => {
        audioChunks = [];
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = (e) => {
            if (e.data && e.data.size > 0) {
              audioChunks.push(e.data);
            }
          };
          mediaRecorder.onstop = () => {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const url = URL.createObjectURL(blob);
            audioPreview.src = url;
            audioPreview.style.display = 'block';
            playBtn.disabled = false;
            deleteBtn.disabled = false;
    
            const reader = new FileReader();
            reader.onloadend = () => {
              audioBlobInput.value = reader.result;  // base64 string
            };
            reader.readAsDataURL(blob);
          };
          mediaRecorder.start();
    
          recordBtn.disabled = true;
          stopBtn.disabled = false;
        } catch (err) {
          console.error('Erreur d‚Äôacc√®s au micro :', err);
          alert("Impossible d'acc√©der au micro.");
        }
      });
    
      stopBtn.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
        }
        stopBtn.disabled = true;
        recordBtn.disabled = false;
      });
    
      playBtn.addEventListener('click', () => {
        audioPreview.play();
      });
    
      deleteBtn.addEventListener('click', () => {
        audioPreview.src = '';
        audioPreview.style.display = 'none';
        audioBlobInput.value = '';
        playBtn.disabled = true;
        deleteBtn.disabled = true;
      });
    });
    </script>
    
{% endblock %}


{% comment %} {% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="pt-8 bg-white">


    <div class="max-w-6xl mx-auto text-center">
        <div class="container mx-auto mt-4">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} p-4 rounded-md mb-4">
                    <p class="text-center text-sm">{{ message }}</p>
                </div>
            {% endfor %}
        </div>
        <!-- Titre de la page -->
        <div class="relative w-full h-96 mt-8">

            <!-- Ajout de -mt-16 pour supprimer la marge -->
            <!-- Image en arri√®re-plan -->
            <img src="{% static 'img/lushipalais.jpg' %}" alt="Image de fond" class="absolute inset-0 w-full h-full object-cover rounded-lg">
            
            <!-- Contenu superpos√© -->
            <div class="absolute inset-0 bg-black bg-opacity-50 flex flex-col justify-center items-center text-center p-6">
                <h2 class="text-3xl font-semibold text-white mb-6 mt-12">D√©tails de la requ√™te client</h2>
                <h2 class="text-3xl font-semibold text-white mb-6">{{ requete.type_bien }} √† {{ requete.commune }}</h2>
                
                <div class="bg-green-100 bg-opacity-80 p-6 rounded-lg shadow-md mb-6">
                    <h3 class="text-xl font-semibold text-green-800">Un client recherche  un(e) {{ requete.type_bien }} √† {{ requete.commune }}</h3>
                    <p class="text-lg text-gray-600">
                        Aidez-le √† trouver le bien parfait pour lui ! Si votre description de ce {{ requete.type_bien }} correspond √† ce qu'il recherche, nous vous mettrons directement en contact avec lui. 
                        <strong>Gagnez vos commissions</strong> en offrant des biens qui r√©pondent au besoins des clients !
                    </p>
                </div>
            </div>
        </div>

        <!-- Affichage des d√©tails de la requ√™te -->
        <div class="bg-gray-50 p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-xl font-bold text-gray-800 mb-2"> Recherche {{ requete.type_bien }} √† {{ requete.commune }}</h3>
            <p class="text-lg text-gray-600 mb-4">{{ requete.description }}</p>
            
            <!-- Affichage du fichier audio si pr√©sent dans la requ√™te -->
            {% if requete.audio %}
            <div class="mt-4">
                <p class="text-sm text-gray-600">√âcoutez la description audio de cette requ√™te :</p>
                <audio controls class="w-full mt-2">
                    <source src="{{ requete.audio.url }}" type="audio/mpeg">
                    Votre navigateur ne supporte pas l'√©l√©ment audio.
                </audio>
            </div>
            {% endif %}
            <p class="text-sm text-gray-500 mb-2">Nombre de r√©ponses : <strong>{{ responses_count }}</strong></p>
        </div>

        <!-- Formulaire de r√©ponse -->
        <div class="bg-white p-6 rounded-lg shadow-md max-w-4xl mx-auto">
            <h4 class="text-2xl font-semibold mb-6 text-center">R√©pondre √† cette requ√™te si Vous avez un bien immobilier tel que d√©crit par le client. </h4>

            <form method="POST" enctype="multipart/form-data" class="space-y-4">
                {% csrf_token %}

                <!-- Champ Nom -->
                <div>
                    <label for="nom" class="block text-sm font-medium text-gray-700">Nom</label>
                    <input type="text" id="nom" name="nom" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Entrez votre nom" required>
                </div>

                <!-- Champ Post-nom -->
                <div>
                    <label for="post_nom" class="block text-sm font-medium text-gray-700">Post-nom</label>
                    <input type="text" id="post_nom" name="post_nom" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Entrez votre post-nom" required>
                </div>

                <!-- Champ Email -->
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" name="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Entrez votre email" required>
                </div>

                <!-- Champ T√©l√©phone -->
                <div>
                    <label for="telephone" class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
                    <input type="text" id="telephone" name="telephone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Entrez votre num√©ro de t√©l√©phone" required>
                </div>

                <!-- Champ Message (Description de la r√©ponse) -->
                <div>
                    <label for="message" class="block text-sm font-medium text-gray-700">Votre message</label>
                    <textarea id="message" name="message" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="D√©crivez votre r√©ponse" rows="4" required></textarea>
                </div>

                <!-- Champ Audio (facultatif) -->
                

                <!-- Bouton Soumettre -->
                <div class="flex justify-center items-center mt-6">
                    <button type="submit" class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Soumettre ma r√©ponse
                    </button>
                </div>
            </form>
        </div>
    </div>
</section>
{% endblock %} {% endcomment %}
