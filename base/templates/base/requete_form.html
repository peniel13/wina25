{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-6 px-4 sm:px-6 lg:px-8">
    {% for message in messages %}
        <div class="alert alert-{{ message.tags }} p-4 rounded-lg mb-4">
            {{ message }}
        </div>
    {% endfor %}
</div>

<section class="py-16 bg-white px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto text-center">
        <h2 class="text-3xl font-semibold mb-6">Fournissez votre requ√™te de recherche</h2>
        <p class="text-lg mb-6 text-gray-700">Cherchez une maison, boutique, h√¥tel, etc. Remplissez ce formulaire pour nous faire part de vos besoins.</p>

        <form method="POST" enctype="multipart/form-data" class="space-y-4 text-left">
            {% csrf_token %}

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="nom" class="block text-sm font-medium text-gray-700">Nom</label>
                    {{ form.nom }}
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    {{ form.email }}
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="telephone" class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
                    {{ form.telephone }}
                </div>
                <div>
                    <label for="commune" class="block text-sm font-medium text-gray-700">Commune</label>
                    {{ form.commune }}
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="country" class="block text-sm font-medium text-gray-700">Pays</label>
                    {{ form.country }}
                </div>
                <div>
                    <label for="city" class="block text-sm font-medium text-gray-700">Ville</label>
                    {{ form.city }}
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label for="type_bien" class="block text-sm font-medium text-gray-700">Type de bien</label>
                    {{ form.type_bien }}
                </div>
                <div>
                    <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                    {{ form.description }}
                </div>
            </div>
             <!-- Bloc audio (facultatif) -->
  <!-- Bloc audio (facultatif) -->
<div class="mt-4 space-y-2">
  <label class="block text-sm font-medium text-gray-700">Votre description audio (facultative)</label>

  <!-- Indicateur d'enregistrement -->
  <div id="recording-indicator" class="hidden mb-2 text-red-600 font-semibold flex items-center gap-2">
    <span class="animate-pulse">‚óè</span> Enregistrement en cours‚Ä¶
  </div>

  <div class="flex flex-wrap gap-2">
    <button type="button" id="record-btn" class="flex-1 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm sm:text-base">üé§ Enregistrer</button>
    <button type="button" id="stop-btn" class="flex-1 px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 text-sm sm:text-base" disabled>‚èπ Arr√™ter</button>
    <button type="button" id="play-btn" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm sm:text-base" disabled>‚ñ∂ R√©√©couter</button>
    <button type="button" id="delete-btn" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm sm:text-base" disabled>üóë Supprimer</button>
  </div>

  <audio id="audio-preview" controls class="hidden w-full mt-2"></audio>
  <input type="hidden" name="audio_blob" id="audio-blob-input">

  <!-- Upload audio classique -->
  <div>
    <label for="id_audio" class="block text-sm font-medium text-gray-700">Ou t√©l√©chargez un fichier audio</label>
    {{ form.audio }}
  </div>
</div>

            <div class="flex justify-between items-center mt-4">
                <button type="submit" class="w-full py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Soumettre la requ√™te
                </button>
            </div>
        </form>
    </div>
</section>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    let mediaRecorder;
    let audioChunks = [];
  
    const recordBtn = document.getElementById('record-btn');
    const stopBtn = document.getElementById('stop-btn');
    const playBtn = document.getElementById('play-btn');
    const deleteBtn = document.getElementById('delete-btn');
    const audioPreview = document.getElementById('audio-preview');
    const audioBlobInput = document.getElementById('audio-blob-input');
    const recordingIndicator = document.getElementById('recording-indicator');
  
    recordBtn.addEventListener('click', async () => {
      audioChunks = [];
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
  
        mediaRecorder.ondataavailable = e => {
          if (e.data && e.data.size > 0) {
            audioChunks.push(e.data);
          }
        };
  
        mediaRecorder.onstart = () => {
          recordingIndicator.classList.remove('hidden'); // montre l‚Äôindicateur
        };
  
        mediaRecorder.onstop = () => {
          recordingIndicator.classList.add('hidden'); // cache l‚Äôindicateur
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          audioPreview.src = url;
          audioPreview.classList.remove('hidden');
          playBtn.disabled = false;
          deleteBtn.disabled = false;
  
          const reader = new FileReader();
          reader.onloadend = () => {
            audioBlobInput.value = reader.result; // base64
          };
          reader.readAsDataURL(blob);
        };
  
        mediaRecorder.start();
        recordBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        console.error('Erreur d‚Äôacc√®s au micro :', err);
        alert("Impossible d'acc√©der au micro.");
      }
    });
  
    stopBtn.addEventListener('click', () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
      }
      stopBtn.disabled = true;
      recordBtn.disabled = false;
    });
  
    playBtn.addEventListener('click', () => {
      audioPreview.play();
    });
  
    deleteBtn.addEventListener('click', () => {
      audioPreview.src = '';
      audioPreview.classList.add('hidden');
      audioBlobInput.value = '';
      playBtn.disabled = true;
      deleteBtn.disabled = true;
    });
  });
  
    </script>
    
{% endblock %}
