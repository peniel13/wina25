{% extends "base.html" %}
{% load static %}

{% block content %}
<!-- ‚úÖ Toast Notification -->
<div id="toast"
     class="fixed bottom-6 right-6 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg z-50 hidden transition-opacity duration-500">
  <span id="toast-message"></span>
</div>
{% if invite_timer_active %}
<div id="timer-message" style="background:#d4edda; color:#155724; padding:10px; margin-bottom:20px; border-radius:4px;">
  Vous √™tes en visite validante, restez sur la page 1 minute pour gagner votre visite.
  <br>
  Temps restant : <span id="timer">60</span> secondes
</div>

<script>
  let timeLeft = 60;
  const timerEl = document.getElementById('timer');

  const countdown = setInterval(() => {
    timeLeft--;
    timerEl.textContent = timeLeft;
    if (timeLeft <= 0) {
      clearInterval(countdown);
      document.getElementById('timer-message').textContent = "Temps √©coul√©, votre visite sera comptabilis√©e au prochain chargement de la page.";
    }
  }, 1000);
</script>
{% endif %}

<!-- Header section avec l'image de fond -->
<section class="relative bg-cover bg-center h-96" style="background-image: url('{{ store.thumbnail.url }}');">
    <div class="absolute inset-0 bg-gray-800 opacity-50"></div>
    <div class="container mx-auto h-full flex items-center justify-center relative z-10 px-4">
        <div class="text-center text-white">
            <!-- Utilisation de classes responsive pour adapter la taille du texte -->
            <h1 class="text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-bold">Bienvenue sur : {{ store.name }}</h1>
            <p class="text-lg sm:text-2xl mt-2">{{ store.commune }}</p>
             <!-- ‚úÖ Pays + drapeau -->
    {% if store.country %}
    <div class="mt-2 flex items-center justify-center gap-2">
        {% if store.country.flag %}
            <img src="{{ store.country.flag.url }}" alt="{{ store.country.name }}" class="w-6 h-4 object-cover rounded-sm border">
        {% endif %}
        <span class="text-lg">{{ store.country.name }}</span>
    </div>
  {% endif %}
            <!-- Affichage des autres informations directement dans le header -->
            <div class="mt-4 text-lg">
                <p class="text-white mb-4">
                    <strong>Description :</strong>
                    {{ store.description|truncatechars:70 }}
                    {% if store.description|length > 70 %}
                        <button 
                            type="button" 
                            class="text-white underline ml-2 hover:text-gray-200" 
                            onclick="openModalDescrip('store')">
                            Lire plus
                        </button>
                    {% endif %}
                </p>
                
                <!-- MODAL -->
                <div id="modal-store" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                    <div class="bg-white rounded-lg shadow-lg max-w-xl w-full p-6 relative">
                        <button onclick="closeModalDescrip('store')" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                        <h2 class="text-2xl font-semibold mb-4">Description compl√®te du store</h2>
                        <p class="text-gray-800 whitespace-pre-line">{{ store.description }}</p>
                    </div>
                </div>
                
                <p><strong>Categorie :</strong> {{ store.typestore }}</p>
                <p><strong>Type :</strong> {{ store.typebusiness }}</p>
                <p><strong>Ville :</strong> {{ store.city.name }}</p>
                <p class="text-white mb-4">
                  <strong>Adresse :</strong>
                  {{ store.adresse|truncatechars:20 }}
                  {% if store.adresse|length > 20 %}
                    <button 
                      type="button" 
                      class="text-white underline ml-2 hover:text-gray-200" 
                      onclick="openModalAdresse('adresse')">
                      Lire plus
                    </button>
                  {% endif %}
                </p>
                
                <!-- MODAL pour l'adresse -->
                <div id="modal-adresse" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
                  <div class="bg-white rounded-lg shadow-lg max-w-xl w-full p-6 relative">
                    <button onclick="closeModalAdresse('adresse')" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                    <h2 class="text-2xl font-semibold mb-4">Adresse compl√®te du store</h2>
                    <p class="text-gray-800 whitespace-pre-line">{{ store.adresse }}</p>
                  </div>
                </div>
                
            </div>
        </div>
    </div>
</section>


<!-- Boutons pour cr√©er une cat√©gorie et un produit -->
{% if store.owner == user %}
<div class="container mx-auto mt-8 text-center">
    <div class="flex flex-col sm:flex-row justify-center gap-4">
        <!-- Lien vers la cr√©ation d'une cat√©gorie -->
        <a href="{% url 'create_category' store.slug %}" 
           class="w-auto px-4 py-2 sm:px-6 sm:py-3 text-white bg-green-600 hover:bg-green-800 rounded-md transition duration-300 mx-auto sm:mx-0">
            Cr√©er une cat√©gorie
        </a>

        <!-- Lien vers la cr√©ation d'un produit -->
        <a href="{% url 'create_product' store.slug %}" 
           class="w-auto px-4 py-2 sm:px-6 sm:py-3 text-white bg-blue-600 hover:bg-blue-800 rounded-md transition duration-300 mx-auto sm:mx-0">
            Cr√©er un produit
        </a>

        <!-- Lien vers la gestion des produits -->
        <a href="{% url 'manage_product_store' store.slug %}" 
           class="w-auto px-4 py-2 sm:px-6 sm:py-3 text-white bg-yellow-500 hover:bg-yellow-600 rounded-md transition duration-300 mx-auto sm:mx-0">
            Manager vos produits
        </a>
        <a href="{% url 'assign_category' store.id %}" 
           class="w-auto px-4 py-2 sm:px-6 sm:py-3 text-white bg-blue-600 hover:bg-blue-800 rounded-md transition duration-300 mx-auto sm:mx-0">
           Assigner une cat√©gorie √† un produit
        </a>
        <a href="{% url 'add_or_update_spotpub' store.slug %}" 
   class="w-auto px-4 py-2 sm:px-6 sm:py-3 text-white bg-red-500 hover:bg-red-600 rounded-md transition duration-300 mx-auto sm:mx-0">
   Ajouter ou Modifier le Spot Pub
</a>
<a href="{% url 'create_notification' store.slug %}" 
class="w-auto px-4 py-2 sm:px-6 sm:py-3 text-white bg-green-600 hover:bg-green-800 rounded-md transition duration-300 mx-auto sm:mx-0">
 Cr√©er une notification
</a>
<a href="{% url 'creer_invite_visibilite_store' store.id %}" 
class="w-auto px-4 py-2 sm:px-6 sm:py-3 text-white bg-green-600 hover:bg-green-800 rounded-md transition duration-300 mx-auto sm:mx-0">
 Cr√©er visibites
</a>
    </div>
</div>

{% comment %} <div class="container mx-auto mt-8 text-center">
    <div class="flex flex-col sm:flex-row justify-center gap-4">
        <!-- Lien vers la cr√©ation d'une cat√©gorie -->
        <a href="{% url 'create_category' store.slug %}" class="inline-block px-6 py-3 text-white bg-green-600 hover:bg-green-800 rounded-md transition duration-300">
            Cr√©er une cat√©gorie
        </a>

        <!-- Lien vers la cr√©ation d'un produit -->
        <a href="{% url 'create_product' store.slug %}" class="inline-block px-6 py-3 text-white bg-blue-600 hover:bg-blue-800 rounded-md transition duration-300">
            Cr√©er un produit
        </a>

        <!-- Lien vers la gestion des produits -->
        <a href="{% url 'manage_product_store' store.slug %}" class="inline-block px-6 py-3 text-white bg-yellow-500 hover:bg-yellow-600 rounded-md transition duration-300">
            Manager vos produits
        </a>
    </div>
</div> {% endcomment %}

{% endif %}
<div class="bg-white shadow p-4 rounded mt-4">
    <h3 class="text-lg font-semibold mb-2">üëÅ Statistiques des visites de {{ store.name }}</h3>
    <p><strong>Visiteurs aujourd'hui :</strong> {{ daily_visits }}</p>
    <p><strong>Compteur de visiteurs  :</strong> {{ weekly_visits }}</p>
</div>
<!-- Note du Store (identique √† list_store) -->
<div class="flex flex-col items-center justify-center mt-6 mb-4 text-center">
  <div class="flex items-center space-x-1 text-lg">
    {% with rating=store.average_rating|default:0 %}
      {% for i in "12345" %}
        {% if rating >= forloop.counter %}
          <i class="bx bxs-star text-yellow-400"></i>
        {% elif rating >= forloop.counter0|add:"0.5" %}
          <i class="bx bxs-star-half text-yellow-400"></i>
        {% else %}
          <i class="bx bx-star text-yellow-400"></i>
        {% endif %}
      {% endfor %}
    {% endwith %}
  </div>
  <span class="text-sm text-gray-500 mt-2">Note moyenne de {{ store.name }} : {{ average_rating|floatformat:1 }}/10</span>
</div>

<div class="flex items-center justify-center mt-4 space-x-2 text-gray-700 text-sm">
    <span class="text-xl">üë•</span>
    <p class="text-center">
        Nombre d'abonn√© : <strong>{{ store.subscribers.count }}</strong> abonn√©(s){{ store.subscribers.count|pluralize:"s" }}
    </p>
</div>

{% if user.is_authenticated %}
<div class="flex flex-col items-center justify-center space-y-4 my-6">
    {% if not is_subscribed %}
        <p class="text-lg font-medium text-gray-800 text-center">
            Abonnez-vous √† {{ store.name }} pour recevoir des notifications des nouveaut√©s.
        </p>
    {% endif %}
    <button id="subscribe-btn"
            data-store-slug="{{ store.slug }}"
            class="px-4 py-2 rounded-md font-semibold transition
                {% if is_subscribed %}
                    bg-red-600 text-white hover:bg-red-700
                {% else %}
                    bg-blue-600 text-white hover:bg-blue-700
                {% endif %}">
        {% if is_subscribed %}
            Se d√©sabonner
        {% else %}
            S‚Äôabonner
        {% endif %}
    </button>
    <p id="subscriber-count" class="text-sm text-gray-500">Abonn√©s : {{ store.subscribers.count }}</p>
</div>
{% endif %}


<!-- Formulaire de recherche et filtres -->
<section class="container mx-auto mt-8 px-4">
    <h2 class="text-3xl font-bold mb-4">
        Produits du store {{ store.name }}: 
        <span class="text-xl font-semibold text-gray-800">
             ({{ total_products }}produits, {{ category_count }} cat√©gories)
        </span>
        
    </h2>
    
    <!-- Formulaire de recherche et filtres pour desktop -->
    <section id="search" class="hidden sm:block">
        <form method="GET" action="#produits" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <div class="flex flex-col">
                <label for="nom" class="text-lg font-semibold">Nom du produit</label>
                <input type="text" name="nom" value="{{ product_name }}" placeholder="Rechercher par nom" class="px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            
            <div class="flex flex-col">
                <label for="categorie" class="text-lg font-semibold">Cat√©gorie</label>
                <select name="categorie" class="px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">Toutes</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        
            <div class="flex flex-col">
                <label for="prix_min" class="text-lg font-semibold">Prix min</label>
                <input type="number" name="prix_min" value="{{ prix_min }}" placeholder="Prix minimum" class="px-4 py-2 border border-gray-300 rounded-lg">
            </div>
        
            <div class="flex flex-col">
                <label for="prix_max" class="text-lg font-semibold">Prix max</label>
                <input type="number" name="prix_max" value="{{ prix_max }}" placeholder="Prix maximum" class="px-4 py-2 border border-gray-300 rounded-lg">
            </div>
        
            <div class="flex justify-center items-end sm:col-span-2 lg:col-span-4 mt-6">
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full sm:w-auto">
                    Rechercher
                </button>
            </div>
        </form>
    </section>

    <!-- Formulaire de recherche et filtres pour mobile -->
    <section id="search-slide" class="sm:hidden fixed top-0 left-0 w-full bg-gray-900 bg-opacity-75 z-50 hidden">
        <div class="flex justify-between items-center p-4">
            <h2 class="text-white font-semibold">Filtres de recherche</h2>
            <button id="close-slide" class="text-white">X</button>
        </div>
        <form method="GET" action="#produits" class="p-4 bg-white">
            <div class="flex flex-col mb-4">
                <label for="nom" class="text-lg font-semibold">Nom du produit</label>
                <input type="text" name="nom" value="{{ product_name }}" placeholder="Rechercher par nom" class="px-4 py-2 border border-gray-300 rounded-lg">
            </div>
            
            <div class="flex flex-col mb-4">
                <label for="categorie" class="text-lg font-semibold">Cat√©gorie</label>
                <select name="categorie" class="px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">Toutes</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" {% if category_filter == category.id|stringformat:"s" %}selected{% endif %}>{{ category.name }}</option>
                    {% endfor %}
                </select>
            </div>
        
            <div class="flex flex-col mb-4">
                <label for="prix_min" class="text-lg font-semibold">Prix min</label>
                <input type="number" name="prix_min" value="{{ prix_min }}" placeholder="Prix minimum" class="px-4 py-2 border border-gray-300 rounded-lg">
            </div>
        
            <div class="flex flex-col mb-4">
                <label for="prix_max" class="text-lg font-semibold">Prix max</label>
                <input type="number" name="prix_max" value="{{ prix_max }}" placeholder="Prix maximum" class="px-4 py-2 border border-gray-300 rounded-lg">
            </div>
        
            <div class="flex justify-center items-end">
                <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
                    Rechercher
                </button>
            </div>
        </form>
    </section>

    <!-- Bouton pour afficher la recherche mobile -->
    <!-- Bouton pour ouvrir les filtres (mobile) -->
    <div class="sm:hidden text-center mt-4 mb-8">
        <button id="open-slide" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full">
            Ouvrir recherche rapide
        </button>
    </div>
</section>
<section id="produits_scrollables" class="py-4 bg-gray-100">
   
    <p class="text-center mb-8">Faites d√©filer horizontalement pour d√©couvrir vos articles ou services de {{ store.name }}</p>
    <div class="overflow-x-auto px-4">
      <div class="flex space-x-6 w-max">
        {% for product in featured_products %}
        <div class="flex-shrink-0 w-64 border-2 border-secondary bg-slate-100 text-black rounded-xl cursor-pointer 
                    hover:scale-105 hover:shadow-lg transition-transform duration-300 ease-in-out flex flex-col h-full">
    
          {% if product.store.country.flag %}
          <div class="flex justify-center items-center mb-2">
            <img src="{{ product.store.country.flag.url }}" alt="{{ product.store.country.name }}" class="w-6 h-4 object-cover mr-2 rounded-sm">
            <span class="text-sm text-gray-700">{{ product.store.country.name }}</span>
          </div>
          {% endif %}
    
          <div>
            {% if product.video %}
              <video autoplay muted loop playsinline
                     class="rounded-t-xl w-full h-40 object-cover cursor-pointer"
                     onclick="this.muted = !this.muted; this.controls = true;">
                <source src="{{ product.video.url }}" type="video/mp4">
                Votre navigateur ne supporte pas la lecture vid√©o.
              </video>
            {% elif product.image %}
              <img src="{{ product.image.url }}" alt="{{ product.name }}"
                   class="rounded-t-xl w-full h-40 object-cover"
                   onclick="showImagePopup('{{ product.image.url }}')" />
            {% else %}
              <div class="rounded-t-xl w-full h-40 bg-gray-300 flex items-center justify-center text-gray-600 text-sm">
                Pas de m√©dia
              </div>
            {% endif %}
          </div>
    
          <!-- Contenu -->
          <div class="flex flex-col justify-between flex-grow p-4 space-y-3">
            <!-- Ajout au panier -->
            <form id="add-to-cart-form-{{ product.id }}" action="{% url 'add_to_cart_ajax' product.id %}" method="POST">
              {% csrf_token %}
              <button type="submit" class="w-full px-4 py-2 bg-blue-500 text-white rounded-full text-sm hover:bg-blue-600 transition">
                Ajouter au panier
              </button>
            </form>
    
            <!-- Nom et prix -->
            <div class="text-center">
              <h1 class="font-semibold text-lg text-primary">{{ product.name }}</h1>
              <h2 class="font-medium text-md">{{ product.price_with_commission }} {{ product.store.country.devise_info.devise }}</h2>
            </div>
    
            <!-- √âtoiles et note -->
            <div class="flex items-center justify-center space-x-2">
              <div class="flex text-yellow-500 text-sm">
                {% with rating=product.average_rating|default:0 %}
                  {% for i in "12345" %}
                    {% if rating >= forloop.counter %}
                      <i class="bx bxs-star text-yellow-400 text-xs"></i>
                    {% elif rating >= forloop.counter0|add:"0.5" %}
                      <i class="bx bxs-star-half text-yellow-400 text-xs"></i>
                    {% else %}
                      <i class="bx bx-star text-yellow-400 text-xs"></i>
                    {% endif %}
                  {% endfor %}
                {% endwith %}
              </div>
            </div>
    
            <!-- D√©tails -->
            <a href="{% url 'product_detail_wina' product.id %}" class="block text-center mt-auto px-4 py-2 bg-blue-500 text-white rounded-full text-sm hover:bg-blue-600 transition">
              Voir les d√©tails
            </a>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    
  </section>
<!-- Affichage des produits -->
 
<section id="produits" class="pb-10 pt-12 bg-gray-100">
   
    <div class="flex flex-wrap gap-6 justify-center">
      {% for product in products %}
      <div class="flex-shrink-0 border-2 border-secondary bg-slate-100 text-black rounded-xl mb-6 cursor-pointer hover:scale-95 hover:bg-slate-200 transition duration-200 ease-linear w-64 h-full flex flex-col">
    
        {% if product.store.country.flag %}
        <div class="flex justify-center items-center mb-2">
          <img src="{{ product.store.country.flag.url }}" alt="{{ product.store.country.name }}"
               class="w-6 h-4 object-cover mr-2 rounded-sm">
          <span class="text-sm text-gray-700">{{ product.store.country.name }}</span>
        </div>
        {% endif %}
    
        <!-- ‚úÖ Image ou Vid√©o -->
        <div>
          {% if product.video %}
            <video autoplay muted loop playsinline
                   class="rounded-t-xl w-full h-40 object-cover cursor-pointer"
                   onclick="this.muted = !this.muted; this.controls = true;">
              <source src="{{ product.video.url }}" type="video/mp4">
              Votre navigateur ne supporte pas la lecture vid√©o.
            </video>
          {% elif product.image %}
            <img src="{{ product.image.url }}" alt="{{ product.name }}"
                 class="rounded-t-xl w-full h-40 object-cover"
                 onclick="showImagePopup('{{ product.image.url }}')" />
          {% else %}
            <div class="rounded-t-xl w-full h-40 bg-gray-300 flex items-center justify-center text-gray-600 text-sm">
              Pas de m√©dia
            </div>
          {% endif %}
        </div>
    
        <!-- üõí Contenu -->
        <div class="flex flex-col justify-between flex-grow p-4">
          <form id="add-to-cart-form-{{ product.id }}" action="{% url 'add_to_cart_ajax' product.id %}" method="POST">
            {% csrf_token %}
            <button type="submit"
                    class="w-full px-4 py-2 bg-blue-500 text-white rounded-full text-sm hover:bg-blue-600 transition">
              Ajouter au panier
            </button>
          </form>
    
          <!-- üè∑ Nom & Prix -->
          <div class="flex flex-col items-center my-4">
            <h1 class="font-semibold text-xl text-primary pt-2 text-center">{{ product.name }}</h1>
            <h2 class="font-medium text-lg text-center">{{ product.price_with_commission }} {{ product.store.country.devise_info.devise }}</h2>
          </div>
    
          <!-- ‚≠ê Note -->
          <div class="flex items-center justify-center my-2">
            <div class="flex text-yellow-500 text-sm">
              {% with rating=product.average_rating|default:0 %}
                {% for i in "12345" %}
                  {% if rating >= forloop.counter %}
                    <i class="bx bxs-star text-yellow-400 text-xs"></i>
                  {% elif rating >= forloop.counter0|add:"0.5" %}
                    <i class="bx bxs-star-half text-yellow-400 text-xs"></i>
                  {% else %}
                    <i class="bx bx-star text-yellow-400 text-xs"></i>
                  {% endif %}
                {% endfor %}
              {% endwith %}
            </div>
          </div>
    
          <!-- üîé D√©tails -->
          <a href="{% url 'product_detail_wina' product.id %}"
             class="block text-center mt-auto px-4 py-2 bg-blue-500 text-white rounded-full text-sm hover:bg-blue-600 transition">
            Voir les d√©tails
          </a>
        </div>
      </div>
      {% empty %}
      <p>Aucun produit ou service trouv√© pour cette recherche.</p>
      {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if products.has_other_pages %}
    <div class="mt-8">
        <nav aria-label="Pagination des produits" class="flex justify-center">
            <ul class="flex space-x-4">
                
                {% if products.has_previous %}
                <li>
                    <a href="?page=1#produits" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        &laquo; Premi√®re
                    </a>
                </li>
                <li>
                    <a href="?page={{ products.previous_page_number }}#produits" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        
                    </a>
                </li>
                {% endif %}
                
                <!-- Affichage de la page actuelle -->
                <li>
                    <span class="px-4 py-2 bg-blue-600 text-white rounded-lg">
                        {{ products.number }}
                    </span>
                </li>
    
                {% if products.number < products.paginator.num_pages %}
                <li>
                    <a href="?page={{ products.paginator.num_pages }}#produits" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-blue-600 hover:text-white">
                        {{ products.paginator.num_pages }}
                    </a>
                </li>
                {% endif %}
    
                {% if products.has_next %}
                <li>
                    <a href="?page={{ products.next_page_number }}#produits" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        >
                    </a>
                </li>
                <li>
                    <a href="?page={{ products.paginator.num_pages }}#produits" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        Derni√®re &raquo;
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
    {% endif %}
    

</section> 

{% if store.owner == user %}
    <div class="mt-4 flex justify-center">
        <a href="{% url 'contact_store_list' store.id %}" 
           class="inline-block bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
            üì¨ Voir les messages de contact
        </a>
    </div>
{% endif %}

{% if store.spot_pub and store.spot_pub.video %}
<section class="my-10 bg-white rounded-lg shadow p-6">
    <h2 class="text-xl font-semibold mb-4 text-gray-800">Spot Publicitaire de {{ store.name }}</h2>
    
    <video 
        class="w-full rounded-md shadow cursor-pointer" 
        autoplay 
        muted 
        loop 
        playsinline 
        preload="auto"
        onclick="openModalVideo('{{ store.spot_pub.video.url }}')"
    >
        <source src="{{ store.spot_pub.video.url }}" type="video/mp4">
        Votre navigateur ne supporte pas la lecture de vid√©o.
    </video>
</section>

<!-- Modal -->
<div id="videoModal" class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center hidden">
    <div class="relative w-3/4 bg-white p-6 rounded-lg">
        <button onclick="closeModalVideo()" class="absolute top-2 right-2 text-white bg-black p-2 rounded-full">X</button>
        <video id="modalVideo" class="w-full" controls autoplay>
            <source id="modalVideoSource" src="" type="video/mp4">
            Votre navigateur ne supporte pas la lecture de vid√©o.
        </video>
    </div>
</div>
</section>
{% endif %}

<script>
    function openModalVideo(videoUrl) {
        // Mise √† jour du source de la vid√©o dans le modal
        document.getElementById('modalVideoSource').src = videoUrl;
        const videoElement = document.getElementById('modalVideo');
        
        // Assurez-vous que la vid√©o est bien charg√©e avant de commencer la lecture
        videoElement.load();  // Recharger la vid√©o
        videoElement.play();  // Lire la vid√©o automatiquement

        // Affichage du modal
        document.getElementById('videoModal').classList.remove('hidden');
    }

    function closeModalVideo() {
        // Fermer le modal
        document.getElementById('videoModal').classList.add('hidden');
        
        // Mettre en pause la vid√©o lorsque le modal est ferm√©
        const videoElement = document.getElementById('modalVideo');
        videoElement.pause();
    }
</script>

<!-- Section des t√©moignages -->

 <!-- Section des t√©moignages -->
 
 <section id="temoignages" class="py-16 bg-gray-50">
  <div class="max-w-6xl mx-auto px-4 text-center">
    
    <!-- Boutons -->
    <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-8">
      <a href="{% url 'contact_store' store.slug %}" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-800 transition duration-300">
        Contacter {{ store.name }}
      </a>
      {% if user.is_authenticated %}
        <a href="{% url 'add_testimonial' store.slug %}" class="px-6 py-3 bg-green-600 text-white rounded-md hover:bg-green-800 transition duration-300">
          Laisser un t√©moignage
        </a>
      {% else %}
        <p class="text-center text-gray-600">Veuillez vous connecter pour laisser un t√©moignage.</p>
      {% endif %}
    </div>

    <h2 class="text-3xl font-bold mb-4">T√©moignages de {{ store.name }}</h2>

    {% if testimonials %}
      <p class="text-gray-600 mb-10 text-sm">
        {{ testimonials|length }} t√©moignage{{ testimonials|length|pluralize }} pour ce {{ store.typestore }}
      </p>

      <!-- Carrousel t√©moignages Glide -->
      <div class="relative w-full glide-02">
        <div class="overflow-hidden" data-glide-el="track">
          <ul class="flex p-0 m-0 gap-6">
            {% for testimonial in testimonials %}
            <li class="min-w-[250px] md:w-[calc(33.33%-24px)]">
              <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="text-center relative z-10">
                  {% if testimonial.user.profile_pic %}
                    <img src="{{ testimonial.user.profile_pic.url }}" alt="{{ testimonial.user.username }}" class="w-20 h-20 rounded-full mx-auto mb-4">
                  {% else %}
                    <img src="https://bootdey.com/img/Content/avatar/avatar7.png" alt="Default" class="w-20 h-20 rounded-full mx-auto mb-4">
                  {% endif %}
                  <h3 class="text-lg font-semibold">{{ testimonial.user.username }}</h3>
                  <small class="text-blue-500 block mb-2">{{ testimonial.rating }}/10</small>

                  <div class="text-yellow-500 mb-4 text-xl">
                    {% for i in range_10 %}
                      {% if i <= testimonial.rating %}
                        &#9733;
                      {% else %}
                        &#9734;
                      {% endif %}
                    {% endfor %}
                  </div>

                  <div class="text-gray-700 overflow-y-auto max-h-20">  <!-- Limite la hauteur √† 10 lignes -->
                      <p>{{ testimonial.content }}</p>
                  </div>
                  <button 
                    class="mt-4 text-blue-600 hover:underline text-sm font-medium"
                    onclick="openModal('{{ testimonial.id }}')">
                    Voir plus
                  </button>
                </div>
              </div>
            </li>
            {% endfor %}
          </ul>
        </div>

        <!-- Fl√®ches de navigation -->
        <div class="absolute top-1/2 left-0 right-0 flex justify-between items-center px-4 -translate-y-1/2" data-glide-el="controls">
          <button data-glide-dir="<" class="w-10 h-10 bg-white rounded-full shadow flex items-center justify-center hover:bg-gray-200 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
          </button>
          <button data-glide-dir=">" class="w-10 h-10 bg-white rounded-full shadow flex items-center justify-center hover:bg-gray-200 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>
      </div>
    {% else %}
      <p class="text-gray-600 mt-6">Aucun t√©moignage pour le moment.</p>
    {% endif %}
  </div>
</section>


{% if store.owner == user %}
<h2 class="text-3xl font-bold text-center mb-8">Les Ventes par Date</h2>

<!-- Formulaire de recherche par date -->
<form method="get" class="mb-4 text-center" action="#formulaire">
    <input type="date" name="order_date" value="{{ order_date|date:'Y-m-d' }}" class="px-4 py-2 border border-gray-300 rounded-lg" id="order_date_input" />
    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg">Rechercher</button>
</form>

<!-- Section qui affiche les r√©sultats de la recherche -->
                <div id="formulaire">
                    {% if orders_by_date %}
                        <div class="overflow-x-auto">
                            <table class="min-w-full table-auto bg-white shadow-lg rounded-lg">
                                <thead class="bg-blue-600 text-white">
                                    <tr>
                                        <th class="px-6 py-3 text-left">Date</th>
                                        <th class="px-6 py-3 text-left">Nombre de Commandes</th>
                                        <th class="px-6 py-3 text-left">Montant Total</th>
                                        <th class="px-6 py-3 text-left">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for date_info in orders_by_date %}
                                        <tr class="border-t">
                                            <td class="px-6 py-4">{{ date_info.order_date }}</td>
                                            <td class="px-6 py-4">{{ date_info.total_orders }}</td>
                                            <td class="px-6 py-4">{{ date_info.total_amount_sum|floatformat:2 }} {{ store.country.devise_info.devise }}</td>
                                            <td class="px-6 py-4">
                                                <a href="{% url 'orders_by_date_detail' store.slug date_info.order_date %}" class="text-blue-600 hover:text-blue-800">Voir les commandes</a>
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="4" class="text-center py-4">Aucune commande trouv√©e pour cette date.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                   
                
        
        <!-- Pagination -->
        <!-- Pagination -->
        {% comment %} {% if orders_by_date.has_other_pages %}
        <div class="mt-8 mb-12"> <!-- Ajout de mb-12 pour √©viter que la pagination touche le footer -->
            <nav aria-label="Pagination des commandes par date" class="flex justify-center">
                <ul class="flex space-x-4">

                    {% if orders_by_date.has_previous %}
                    <li>
                        <a href="?page={{ orders_by_date.previous_page_number }}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            < Pr√©c√©dente
                        </a>
                    </li>
                    {% endif %}

                    <!-- Affichage de la page actuelle -->
                    <li>
                        <span class="px-4 py-2 bg-blue-600 text-white rounded-lg">
                            {{ orders_by_date.number }}
                        </span>
                    </li>

                    {% if orders_by_date.has_next %}
                    <li>
                        <a href="?page={{ orders_by_date.next_page_number }}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Suivante >
                        </a>
                    </li>
                    {% endif %}

                </ul>
            </nav>
        </div>
        {% endif %} {% endcomment %}
    
    
    {% else %}
        <p class="text-center text-lg text-gray-600">Vous n'avez pas encore de commandes.</p>
    {% endif %}
</div>
{% endif %}
  <!-- üéØ Featured Stores -->

  <section id="favorite_stores" class="pt-4 pb-10 bg-gray-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <h2 class="text-3xl font-semibold mt-6 mb-6 text-center">Stores favoris</h2>
  
      <div class="relative w-full glide-01">
        <!-- Glide Track -->
        <div class="overflow-hidden" data-glide-el="track">
          <ul class="flex gap-6">
            {% for featured in featured_stores %}
              {% with store=featured.store %}
                <li class="min-w-[250px] md:w-[calc(33.33%-24px)]">
                  <a href="{% url 'store_detail' store.slug %}" class="block bg-white rounded-lg shadow-lg hover:shadow-2xl overflow-hidden relative">
                    <div class="h-40 bg-cover bg-center" style="background-image: url('{% if store.thumbnail %}{{ store.thumbnail.url }}{% else %}{% static 'img/default-thumbnail.jpg' %}{% endif %}')">
                      {% if store.country.flag %}
                        <div class="absolute top-2 right-2">
                          <img src="{{ store.country.flag.url }}" class="w-5 h-5 rounded-full border border-white shadow" alt="{{ store.country.name }}">
                        </div>
                      {% endif %}
                    </div>
                    <div class="bg-black bg-opacity-60 text-white p-3 text-sm">
                      <h3 class="font-semibold truncate">{{ store.name }}</h3>
                      <p class="text-xs text-blue-200 italic">{{ store.typestore.nom }}</p>
                      <div class="flex items-center space-x-1 text-xs mt-1">
                        {% with rating=store.average_rating|default:0 %}
                          {% for i in "12345" %}
                            {% if rating >= forloop.counter %}
                              <i class="bx bxs-star text-yellow-400 text-xs"></i>
                            {% elif rating >= forloop.counter0|add:"0.5" %}
                              <i class="bx bxs-star-half text-yellow-400 text-xs"></i>
                            {% else %}
                              <i class="bx bx-star text-yellow-400 text-xs"></i>
                            {% endif %}
                          {% endfor %}
                        {% endwith %}
                      </div>
                      <p class="truncate mt-1">{{ store.adresse }}</p>
                      <p class="text-xs">{{ store.city.name }}, {{ store.country.name }}</p>
                    </div>
                  </a>
                </li>
              {% endwith %}
            {% endfor %}
          </ul>
        </div>
  
        <!-- Contr√¥les -->
        <div class="absolute left-0 flex items-center justify-between w-full h-0 px-4 top-1/2" data-glide-el="controls">
          <button class="inline-flex items-center justify-center w-8 h-8 transition duration-300 border rounded-full lg:w-12 lg:h-12 text-slate-700 border-slate-700 hover:text-slate-900 hover:border-slate-900 bg-white/20" data-glide-dir="<">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 15.75L3 12m0 0l3.75-3.75M3 12h18"/>
            </svg>
          </button>
          <button class="inline-flex items-center justify-center w-8 h-8 transition duration-300 border rounded-full lg:w-12 lg:h-12 text-slate-700 border-slate-700 hover:text-slate-900 hover:border-slate-900 bg-white/20" data-glide-dir=">">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17.25 8.25L21 12m0 0l-3.75 3.75M21 12H3"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </section>
  


<!-- Glide.js Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Glide.js/3.0.2/glide.js"></script>

<script>
    var glide01 = new Glide('.glide-01', {
        type: 'carousel',
        focusAt: 'center',
        perView: 3,
        autoplay: 3000,
        animationDuration: 700,
        gap: 24,
        classes: {
            activeNav: '[&>*]:bg-slate-700',
        },
        breakpoints: {
            1024: {
                perView: 2
            },
            640: {
                perView: 1
            }
        },
    });

    glide01.mount();
</script>

<!-- Modal de confirmation d'ajout au panier -->
<!-- Modal de confirmation d'ajout au panier -->
<div id="add-to-cart-modal" class="fixed inset-0 bg-gray-800 bg-opacity-50 z-50 hidden justify-center items-center">
    <div class="bg-white rounded-lg p-6 text-center max-w-sm mx-auto">
        <h2 class="text-xl font-semibold text-green-600">Produit ajout√© au panier !</h2>
        <p class="text-gray-700 mt-2">Le produit a √©t√© ajout√© avec succ√®s √† votre panier.</p>
        <button id="close-modal" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
            Fermer
        </button>
    </div>
</div>
<!-- Popup pour afficher l'image agrandie -->
<div id="imagePopup" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center hidden">
    <div class="bg-white p-4 rounded-xl max-w-lg">
        <span class="absolute top-0 right-0 p-3 cursor-pointer text-white bg-red-600 rounded-full text-3xl flex justify-center items-center" onclick="hideImagePopup()">X</span>
        <img id="popupImage" src="" alt="Image agrandie" class="w-full h-auto rounded-lg">
    </div>
</div>
<!-- Modal de t√©moignage -->
<div id="testimonialModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white w-full max-w-lg rounded-lg p-6 relative">
      <button onclick="closeModal()" class="absolute top-2 right-3 text-gray-600 hover:text-red-500 text-2xl">&times;</button>
      <h3 class="text-xl font-bold mb-2" id="modalUsername"></h3>
      <p class="text-sm text-blue-500 mb-4" id="modalRating"> cotation</p>
      <p class="text-gray-700 leading-relaxed text-sm" id="modalContent"></p>
    </div>
  </div>
 

<script>
    // S√©lectionner tous les formulaires d'ajout au panier
    document.querySelectorAll('.add-to-cart-form').forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Emp√™che le comportement par d√©faut du formulaire

            const url = form.action;
            const data = new FormData(form);

            // Envoyer la requ√™te AJAX
            fetch(url, {
                method: 'POST',
                body: data
            })
            .then(response => response.json())
            .then(data => {
                // Mettre √† jour le nombre d'articles dans le panier
                document.getElementById('cart-items-count').textContent = data.total_items;
                document.getElementById('cart-total-price').textContent = data.total_price + " CDF";

                // Afficher le modal de confirmation
                document.getElementById('add-to-cart-modal').classList.remove('hidden');
            })
            .catch(error => console.error('Erreur:', error));
        });
    });

    // Fermer le modal
    document.getElementById('close-modal').addEventListener('click', function() {
        document.getElementById('add-to-cart-modal').classList.add('hidden');
    });
</script>


<script>
    document.getElementById('open-slide').addEventListener('click', function() {
        document.getElementById('search-slide').classList.remove('hidden');
    });

    document.getElementById('close-slide').addEventListener('click', function() {
        document.getElementById('search-slide').classList.add('hidden');
    });
    // Afficher le popup avec l'image agrandie
   function showImagePopup(imageUrl) {
    document.getElementById('popupImage').src = imageUrl;
    document.getElementById('imagePopup').classList.remove('hidden');
}

// Masquer le popup
function hideImagePopup() {
    document.getElementById('imagePopup').classList.add('hidden');
}
</script>
<!-- Scripts pour le panier -->
{% comment %} iii {% endcomment %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/Glide.js/3.0.2/glide.js"></script>

<script>
  var glide02 = new Glide('.glide-02', {
    type: 'carousel',
    focusAt: 'center',
    perView: 3,
    autoplay: 3000,
    animationDuration: 700,
    gap: 24,
    classes: {
      activeNav: '[&>*]:bg-slate-700',
    },
    breakpoints: {
      1024: {
        perView: 2
      },
      640: {
        perView: 1
      }
    },
  });

  glide02.mount();
</script>

<!-- JS Slide Search -->
<script>
    const openSlideButton = document.getElementById('open-slide');
    const searchSlide = document.getElementById('search-slide');
    const closeSlideButton = document.getElementById('close-slide');
  
    openSlideButton?.addEventListener('click', () => {
      searchSlide?.classList.remove('hidden');
    });
  
    closeSlideButton?.addEventListener('click', () => {
      searchSlide?.classList.add('hidden');
    });
  </script>
  
  <!-- Pause scroll au survol (si utilis√© ailleurs) -->
  <script>
    const scrollingContainer = document.getElementById("scrollingStores");
  
    if (scrollingContainer) {
      scrollingContainer.addEventListener("mouseover", function() {
        scrollingContainer.style.animationPlayState = "paused";
      });
  
      scrollingContainer.addEventListener("mouseleave", function() {
        scrollingContainer.style.animationPlayState = "running";
      });
    }
  </script>
  {% comment %} deuxieme {% endcomment %}
  <script>
      const testimonialsData = {
        {% for t in testimonials %}
          "{{ t.id }}": {
            "username": "{{ t.user.username|escapejs }}",
            "rating": "{{ t.rating }}/10",
            "content": `{{ t.content|linebreaksbr|escapejs }}`
          },
        {% endfor %}
      };
    
      function openModal(id) {
        const data = testimonialsData[id];
        document.getElementById("modalUsername").textContent = data.username;
        document.getElementById("modalRating").textContent = data.rating;
        document.getElementById("modalContent").innerHTML = data.content;
        document.getElementById("testimonialModal").classList.remove("hidden");
      }
    
      function closeModal() {
        document.getElementById("testimonialModal").classList.add("hidden");
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
          const btn = document.getElementById("subscribe-btn");
          const countDisplay = document.getElementById("subscriber-count");
      
          if (btn) {
              btn.onclick = function () {
                  const slug = btn.dataset.storeSlug;
      
                  fetch(`/${slug}/toggle-subscription/`, {
                      method: "POST",
                      headers: {
                          "X-CSRFToken": getCookie("csrftoken"),
                          "X-Requested-With": "XMLHttpRequest",
                      },
                  })
                  .then(response => response.json())
                  .then(data => {
                      if (data.subscribed) {
                          btn.textContent = "Se d√©sabonner";
                          btn.classList.remove("bg-blue-600", "hover:bg-blue-700");
                          btn.classList.add("bg-red-600", "hover:bg-red-700");
                          showToast("‚úÖ Vous √™tes maintenant abonn√© !");
                      } else {
                          btn.textContent = "S‚Äôabonner";
                          btn.classList.remove("bg-red-600", "hover:bg-red-700");
                          btn.classList.add("bg-blue-600", "hover:bg-blue-700");
                          showToast("‚ùå Vous vous √™tes d√©sabonn√©.");
                      }
      
                      if (countDisplay && data.subscriber_count !== undefined) {
                          countDisplay.textContent = `Abonn√©s : ${data.subscriber_count}`;
                      }
                  })
                  .catch(error => {
                      console.error("Erreur :", error);
                      showToast("‚ùå Une erreur est survenue.");
                  });
              };
          }
      
          // Fonction pour r√©cup√©rer le token CSRF
          function getCookie(name) {
              let cookieValue = null;
              if (document.cookie && document.cookie !== "") {
                  const cookies = document.cookie.split(";");
                  for (let i = 0; i < cookies.length; i++) {
                      const cookie = cookies[i].trim();
                      if (cookie.substring(0, name.length + 1) === name + "=") {
                          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                          break;
                      }
                  }
              }
              return cookieValue;
          }
      
          // Fonction pour afficher le toast anim√©
          function showToast(message) {
            const toast = document.getElementById("toast");
            const toastMessage = document.getElementById("toast-message");
        
            toastMessage.textContent = message;
        
            toast.classList.remove("hidden", "opacity-0");
            toast.classList.add("opacity-100");
        
            // Cacher apr√®s 3 secondes
            setTimeout(() => {
                toast.classList.remove("opacity-100");
                toast.classList.add("opacity-0");
        
                // Re-appliquer `hidden` apr√®s la transition
                setTimeout(() => {
                    toast.classList.add("hidden");
                }, 500); // correspond √† duration-500
            }, 3000);
        }
        
      });
      </script>
      <script>
        function openModalDescrip(modalId) {
          const modal = document.getElementById(`modal-${modalId}`);
          if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex'); // Pour centrer le contenu si besoin
          }
        }
      
        function closeModalDescrip(modalId) {
          const modal = document.getElementById(`modal-${modalId}`);
          if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
          }
        }
      </script>
      <script>
        function openModalAdresse(id) {
          const modal = document.getElementById(`modal-${id}`);
          if (modal) {
            modal.classList.remove("hidden");
            modal.classList.add("flex");
          }
        }
      
        function closeModalAdresse(id) {
          const modal = document.getElementById(`modal-${id}`);
          if (modal) {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
          }
        }
      </script>
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          const isVisiteActive = {{ is_visite_active|yesno:"true,false" }};
          const storeId = {{ store.id }};
          const csrfToken = "{{ csrf_token }}";
      
          if (isVisiteActive) {
            setTimeout(() => {
              fetch("{% url 'confirmer_visite_ajax' %}", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "X-CSRFToken": csrfToken,
                },
                body: JSON.stringify({store_id: storeId})
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  // Reload page pour voir le message Django affich√©
                  window.location.reload();
                } else if (data.error) {
                  alert("‚ö†Ô∏è " + data.error);
                }
              })
              .catch(err => {
                console.error('Erreur confirmation visite:', err);
              });
            }, 60000);
          }
        });
      </script>
      
      
        
        
{% endblock %}
